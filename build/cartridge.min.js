(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};function setupTypedArray(name,fallback){if(typeof this[name]!=="function"&&typeof this[name]!=="object"){if(typeof this[fallback]==="function"&&typeof this[fallback]!=="object"){this[name]=this[fallback]}else{this[name]=function(obj){if(obj instanceof Array){return obj}else if(typeof obj==="number"){return new Array(obj)}}}}}setupTypedArray("Float64Array","WebGLFloatArray");setupTypedArray("Int32Array","WebGLIntArray");setupTypedArray("Uint16Array","WebGLUnsignedShortArray");setupTypedArray("Uint8Array","WebGLUnsignedByteArray");DSP.invert=function(buffer){for(var i=0,len=buffer.length;i<len;i++){buffer[i]*=-1}return buffer};DSP.interleave=function(left,right){if(left.length!==right.length){throw"Can not interleave. Channel lengths differ."}var stereoInterleaved=new Float64Array(left.length*2);for(var i=0,len=left.length;i<len;i++){stereoInterleaved[2*i]=left[i];stereoInterleaved[2*i+1]=right[i]}return stereoInterleaved};DSP.deinterleave=function(){var left,right,mix,deinterleaveChannel=[];deinterleaveChannel[DSP.MIX]=function(buffer){for(var i=0,len=buffer.length/2;i<len;i++){mix[i]=(buffer[2*i]+buffer[2*i+1])/2}return mix};deinterleaveChannel[DSP.LEFT]=function(buffer){for(var i=0,len=buffer.length/2;i<len;i++){left[i]=buffer[2*i]}return left};deinterleaveChannel[DSP.RIGHT]=function(buffer){for(var i=0,len=buffer.length/2;i<len;i++){right[i]=buffer[2*i+1]}return right};return function(channel,buffer){left=left||new Float64Array(buffer.length/2);right=right||new Float64Array(buffer.length/2);mix=mix||new Float64Array(buffer.length/2);if(buffer.length/2!==left.length){left=new Float64Array(buffer.length/2);right=new Float64Array(buffer.length/2);mix=new Float64Array(buffer.length/2)}return deinterleaveChannel[channel](buffer)}}();DSP.getChannel=DSP.deinterleave;DSP.mixSampleBuffers=function(sampleBuffer1,sampleBuffer2,negate,volumeCorrection){var outputSamples=new Float64Array(sampleBuffer1);for(var i=0;i<sampleBuffer1.length;i++){outputSamples[i]+=(negate?-sampleBuffer2[i]:sampleBuffer2[i])/volumeCorrection}return outputSamples};DSP.LPF=0;DSP.HPF=1;DSP.BPF_CONSTANT_SKIRT=2;DSP.BPF_CONSTANT_PEAK=3;DSP.NOTCH=4;DSP.APF=5;DSP.PEAKING_EQ=6;DSP.LOW_SHELF=7;DSP.HIGH_SHELF=8;DSP.Q=1;DSP.BW=2;DSP.S=3;DSP.RMS=function(buffer){var total=0;for(var i=0,n=buffer.length;i<n;i++){total+=buffer[i]*buffer[i]}return Math.sqrt(total/n)};DSP.Peak=function(buffer){var peak=0;for(var i=0,n=buffer.length;i<n;i++){peak=Math.abs(buffer[i])>peak?Math.abs(buffer[i]):peak}return peak};function FourierTransform(bufferSize,sampleRate){this.bufferSize=bufferSize;this.sampleRate=sampleRate;this.bandwidth=2/bufferSize*sampleRate/2;this.spectrum=new Float64Array(bufferSize/2);this.real=new Float64Array(bufferSize);this.imag=new Float64Array(bufferSize);this.peakBand=0;this.peak=0;this.getBandFrequency=function(index){return this.bandwidth*index+this.bandwidth/2};this.calculateSpectrum=function(){var spectrum=this.spectrum,real=this.real,imag=this.imag,bSi=2/this.bufferSize,sqrt=Math.sqrt,rval,ival,mag;for(var i=0,N=bufferSize/2;i<N;i++){rval=real[i];ival=imag[i];mag=bSi*sqrt(rval*rval+ival*ival);if(mag>this.peak){this.peakBand=i;this.peak=mag}spectrum[i]=mag}}}function DFT(bufferSize,sampleRate){FourierTransform.call(this,bufferSize,sampleRate);var N=bufferSize/2*bufferSize;var TWO_PI=2*Math.PI;this.sinTable=new Float64Array(N);this.cosTable=new Float64Array(N);for(var i=0;i<N;i++){this.sinTable[i]=Math.sin(i*TWO_PI/bufferSize);this.cosTable[i]=Math.cos(i*TWO_PI/bufferSize)}}DFT.prototype.forward=function(buffer){var real=this.real,imag=this.imag,rval,ival;for(var k=0;k<this.bufferSize/2;k++){rval=0;ival=0;for(var n=0;n<buffer.length;n++){rval+=this.cosTable[k*n]*buffer[n];ival+=this.sinTable[k*n]*buffer[n]}real[k]=rval;imag[k]=ival}return this.calculateSpectrum()};function FFT(bufferSize,sampleRate){FourierTransform.call(this,bufferSize,sampleRate);this.reverseTable=new Uint32Array(bufferSize);var limit=1;var bit=bufferSize>>1;var i;while(limit<bufferSize){for(i=0;i<limit;i++){this.reverseTable[i+limit]=this.reverseTable[i]+bit}limit=limit<<1;bit=bit>>1}this.sinTable=new Float64Array(bufferSize);this.cosTable=new Float64Array(bufferSize);for(i=0;i<bufferSize;i++){this.sinTable[i]=Math.sin(-Math.PI/i);this.cosTable[i]=Math.cos(-Math.PI/i)}}FFT.prototype.forward=function(buffer){var bufferSize=this.bufferSize,cosTable=this.cosTable,sinTable=this.sinTable,reverseTable=this.reverseTable,real=this.real,imag=this.imag,spectrum=this.spectrum;var k=Math.floor(Math.log(bufferSize)/Math.LN2);if(Math.pow(2,k)!==bufferSize){throw"Invalid buffer size, must be a power of 2."}if(bufferSize!==buffer.length){throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+bufferSize+" Buffer Size: "+buffer.length}var halfSize=1,phaseShiftStepReal,phaseShiftStepImag,currentPhaseShiftReal,currentPhaseShiftImag,off,tr,ti,tmpReal,i;for(i=0;i<bufferSize;i++){real[i]=buffer[reverseTable[i]];imag[i]=0}while(halfSize<bufferSize){phaseShiftStepReal=cosTable[halfSize];phaseShiftStepImag=sinTable[halfSize];currentPhaseShiftReal=1;currentPhaseShiftImag=0;for(var fftStep=0;fftStep<halfSize;fftStep++){i=fftStep;while(i<bufferSize){off=i+halfSize;tr=currentPhaseShiftReal*real[off]-currentPhaseShiftImag*imag[off];ti=currentPhaseShiftReal*imag[off]+currentPhaseShiftImag*real[off];real[off]=real[i]-tr;imag[off]=imag[i]-ti;real[i]+=tr;imag[i]+=ti;i+=halfSize<<1}tmpReal=currentPhaseShiftReal;currentPhaseShiftReal=tmpReal*phaseShiftStepReal-currentPhaseShiftImag*phaseShiftStepImag;currentPhaseShiftImag=tmpReal*phaseShiftStepImag+currentPhaseShiftImag*phaseShiftStepReal}halfSize=halfSize<<1}return this.calculateSpectrum()};FFT.prototype.inverse=function(real,imag){var bufferSize=this.bufferSize,cosTable=this.cosTable,sinTable=this.sinTable,reverseTable=this.reverseTable,spectrum=this.spectrum;real=real||this.real;imag=imag||this.imag;var halfSize=1,phaseShiftStepReal,phaseShiftStepImag,currentPhaseShiftReal,currentPhaseShiftImag,off,tr,ti,tmpReal,i;for(i=0;i<bufferSize;i++){imag[i]*=-1}var revReal=new Float64Array(bufferSize);var revImag=new Float64Array(bufferSize);for(i=0;i<real.length;i++){revReal[i]=real[reverseTable[i]];revImag[i]=imag[reverseTable[i]]}real=revReal;imag=revImag;while(halfSize<bufferSize){phaseShiftStepReal=cosTable[halfSize];phaseShiftStepImag=sinTable[halfSize];currentPhaseShiftReal=1;currentPhaseShiftImag=0;for(var fftStep=0;fftStep<halfSize;fftStep++){i=fftStep;while(i<bufferSize){off=i+halfSize;tr=currentPhaseShiftReal*real[off]-currentPhaseShiftImag*imag[off];ti=currentPhaseShiftReal*imag[off]+currentPhaseShiftImag*real[off];real[off]=real[i]-tr;imag[off]=imag[i]-ti;real[i]+=tr;imag[i]+=ti;i+=halfSize<<1}tmpReal=currentPhaseShiftReal;currentPhaseShiftReal=tmpReal*phaseShiftStepReal-currentPhaseShiftImag*phaseShiftStepImag;currentPhaseShiftImag=tmpReal*phaseShiftStepImag+currentPhaseShiftImag*phaseShiftStepReal}halfSize=halfSize<<1}var buffer=new Float64Array(bufferSize);for(i=0;i<bufferSize;i++){buffer[i]=real[i]/bufferSize}return buffer};function RFFT(bufferSize,sampleRate){FourierTransform.call(this,bufferSize,sampleRate);this.trans=new Float64Array(bufferSize);this.reverseTable=new Uint32Array(bufferSize);this.reverseBinPermute=function(dest,source){var bufferSize=this.bufferSize,halfSize=bufferSize>>>1,nm1=bufferSize-1,i=1,r=0,h;dest[0]=source[0];do{r+=halfSize;dest[i]=source[r];dest[r]=source[i];i++;h=halfSize<<1;while(h=h>>1,!((r^=h)&h));if(r>=i){dest[i]=source[r];dest[r]=source[i];dest[nm1-i]=source[nm1-r];dest[nm1-r]=source[nm1-i]}i++}while(i<halfSize);dest[nm1]=source[nm1]};this.generateReverseTable=function(){var bufferSize=this.bufferSize,halfSize=bufferSize>>>1,nm1=bufferSize-1,i=1,r=0,h;this.reverseTable[0]=0;do{r+=halfSize;this.reverseTable[i]=r;this.reverseTable[r]=i;i++;h=halfSize<<1;while(h=h>>1,!((r^=h)&h));if(r>=i){this.reverseTable[i]=r;this.reverseTable[r]=i;this.reverseTable[nm1-i]=nm1-r;this.reverseTable[nm1-r]=nm1-i}i++}while(i<halfSize);this.reverseTable[nm1]=nm1};this.generateReverseTable()}RFFT.prototype.forward=function(buffer){var n=this.bufferSize,spectrum=this.spectrum,x=this.trans,TWO_PI=2*Math.PI,sqrt=Math.sqrt,i=n>>>1,bSi=2/n,n2,n4,n8,nn,t1,t2,t3,t4,i1,i2,i3,i4,i5,i6,i7,i8,st1,cc1,ss1,cc3,ss3,e,a,rval,ival,mag;this.reverseBinPermute(x,buffer);for(var ix=0,id=4;ix<n;id*=4){for(var i0=ix;i0<n;i0+=id){st1=x[i0]-x[i0+1];x[i0]+=x[i0+1];x[i0+1]=st1}ix=2*(id-1)}n2=2;nn=n>>>1;while(nn=nn>>>1){ix=0;n2=n2<<1;id=n2<<1;n4=n2>>>2;n8=n2>>>3;do{if(n4!==1){for(i0=ix;i0<n;i0+=id){i1=i0;i2=i1+n4;i3=i2+n4;i4=i3+n4;t1=x[i3]+x[i4];x[i4]-=x[i3];x[i3]=x[i1]-t1;x[i1]+=t1;i1+=n8;i2+=n8;i3+=n8;i4+=n8;t1=x[i3]+x[i4];t2=x[i3]-x[i4];t1=-t1*Math.SQRT1_2;t2*=Math.SQRT1_2;st1=x[i2];x[i4]=t1+st1;x[i3]=t1-st1;x[i2]=x[i1]-t2;x[i1]+=t2}}else{for(i0=ix;i0<n;i0+=id){i1=i0;i2=i1+n4;i3=i2+n4;i4=i3+n4;t1=x[i3]+x[i4];x[i4]-=x[i3];x[i3]=x[i1]-t1;x[i1]+=t1}}ix=(id<<1)-n2;id=id<<2}while(ix<n);e=TWO_PI/n2;for(var j=1;j<n8;j++){a=j*e;ss1=Math.sin(a);cc1=Math.cos(a);cc3=4*cc1*(cc1*cc1-.75);ss3=4*ss1*(.75-ss1*ss1);ix=0;id=n2<<1;do{for(i0=ix;i0<n;i0+=id){i1=i0+j;i2=i1+n4;i3=i2+n4;i4=i3+n4;i5=i0+n4-j;i6=i5+n4;i7=i6+n4;i8=i7+n4;t2=x[i7]*cc1-x[i3]*ss1;t1=x[i7]*ss1+x[i3]*cc1;t4=x[i8]*cc3-x[i4]*ss3;t3=x[i8]*ss3+x[i4]*cc3;st1=t2-t4;t2+=t4;t4=st1;x[i8]=t2+x[i6];x[i3]=t2-x[i6];st1=t3-t1;t1+=t3;t3=st1;x[i4]=t3+x[i2];x[i7]=t3-x[i2];x[i6]=x[i1]-t1;x[i1]+=t1;x[i2]=t4+x[i5];x[i5]-=t4}ix=(id<<1)-n2;id=id<<2}while(ix<n)}}while(--i){rval=x[i];ival=x[n-i-1];mag=bSi*sqrt(rval*rval+ival*ival);if(mag>this.peak){this.peakBand=i;this.peak=mag}spectrum[i]=mag}spectrum[0]=bSi*x[0];return spectrum};function Sampler(file,bufferSize,sampleRate,playStart,playEnd,loopStart,loopEnd,loopMode){this.file=file;this.bufferSize=bufferSize;this.sampleRate=sampleRate;this.playStart=playStart||0;this.playEnd=playEnd||1;this.loopStart=loopStart||0;this.loopEnd=loopEnd||1;this.loopMode=loopMode||DSP.OFF;this.loaded=false;this.samples=[];this.signal=new Float64Array(bufferSize);this.frameCount=0;this.envelope=null;this.amplitude=1;this.rootFrequency=110;this.frequency=550;this.step=this.frequency/this.rootFrequency;this.duration=0;this.samplesProcessed=0;this.playhead=0;var audio=document.createElement("AUDIO");var self=this;this.loadSamples=function(event){var buffer=DSP.getChannel(DSP.MIX,event.frameBuffer);for(var i=0;i<buffer.length;i++){self.samples.push(buffer[i])}};this.loadComplete=function(){self.samples=new Float64Array(self.samples);self.loaded=true};this.loadMetaData=function(){self.duration=audio.duration};audio.addEventListener("MozAudioAvailable",this.loadSamples,false);audio.addEventListener("loadedmetadata",this.loadMetaData,false);audio.addEventListener("ended",this.loadComplete,false);audio.muted=true;audio.src=file;audio.play()}Sampler.prototype.applyEnvelope=function(){this.envelope.process(this.signal);return this.signal};Sampler.prototype.generate=function(){var frameOffset=this.frameCount*this.bufferSize;var loopWidth=this.playEnd*this.samples.length-this.playStart*this.samples.length;var playStartSamples=this.playStart*this.samples.length;var playEndSamples=this.playEnd*this.samples.length;var offset;for(var i=0;i<this.bufferSize;i++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+playStartSamples);if(this.playhead<this.playEnd*this.samples.length){this.signal[i]=this.samples[this.playhead]*this.amplitude}else{this.signal[i]=0}break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%loopWidth+playStartSamples);if(this.playhead<this.playEnd*this.samples.length){this.signal[i]=this.samples[this.playhead]*this.amplitude}break;case DSP.BW:this.playhead=playEndSamples-Math.round(this.samplesProcessed*this.step%loopWidth);if(this.playhead<this.playEnd*this.samples.length){this.signal[i]=this.samples[this.playhead]*this.amplitude}break;case DSP.FWBW:if(Math.floor(this.samplesProcessed*this.step/loopWidth)%2===0){this.playhead=Math.round(this.samplesProcessed*this.step%loopWidth+playStartSamples)}else{this.playhead=playEndSamples-Math.round(this.samplesProcessed*this.step%loopWidth)}if(this.playhead<this.playEnd*this.samples.length){this.signal[i]=this.samples[this.playhead]*this.amplitude}break}this.samplesProcessed++}this.frameCount++;return this.signal};Sampler.prototype.setFreq=function(frequency){var totalProcessed=this.samplesProcessed*this.step;this.frequency=frequency;this.step=this.frequency/this.rootFrequency;this.samplesProcessed=Math.round(totalProcessed/this.step)};Sampler.prototype.reset=function(){this.samplesProcessed=0;this.playhead=0};function Oscillator(type,frequency,amplitude,bufferSize,sampleRate){this.frequency=frequency;this.amplitude=amplitude;this.bufferSize=bufferSize;this.sampleRate=sampleRate;this.frameCount=0;this.waveTableLength=2048;this.cyclesPerSample=frequency/sampleRate;this.signal=new Float64Array(bufferSize);this.envelope=null;switch(parseInt(type,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:case DSP.SINE:this.func=Oscillator.Sine;break}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float64Array(2048);var waveTableTime=this.waveTableLength/this.sampleRate;var waveTableHz=1/waveTableTime;for(var i=0;i<this.waveTableLength;i++){Oscillator.waveTable[this.func][i]=this.func(i*waveTableHz/this.sampleRate)}};if(typeof Oscillator.waveTable==="undefined"){Oscillator.waveTable={}}if(typeof Oscillator.waveTable[this.func]==="undefined"){this.generateWaveTable()}this.waveTable=Oscillator.waveTable[this.func]}Oscillator.prototype.setAmp=function(amplitude){if(amplitude>=0&&amplitude<=1){this.amplitude=amplitude}else{throw"Amplitude out of range (0..1)."}};Oscillator.prototype.setFreq=function(frequency){this.frequency=frequency;this.cyclesPerSample=frequency/this.sampleRate};Oscillator.prototype.add=function(oscillator){for(var i=0;i<this.bufferSize;i++){this.signal[i]+=oscillator.signal[i]}return this.signal};Oscillator.prototype.addSignal=function(signal){for(var i=0;i<signal.length;i++){if(i>=this.bufferSize){break}this.signal[i]+=signal[i]}return this.signal};Oscillator.prototype.addEnvelope=function(envelope){this.envelope=envelope};Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)};Oscillator.prototype.valueAt=function(offset){return this.waveTable[offset%this.waveTableLength]};Oscillator.prototype.generate=function(){var frameOffset=this.frameCount*this.bufferSize;var step=this.waveTableLength*this.frequency/this.sampleRate;var offset;for(var i=0;i<this.bufferSize;i++){offset=Math.round((frameOffset+i)*step);this.signal[i]=this.waveTable[offset%this.waveTableLength]*this.amplitude}this.frameCount++;return this.signal};Oscillator.Sine=function(step){return Math.sin(DSP.TWO_PI*step)};Oscillator.Square=function(step){return step<.5?1:-1};Oscillator.Saw=function(step){return 2*(step-Math.round(step))};Oscillator.Triangle=function(step){return 1-4*Math.abs(Math.round(step)-step)};Oscillator.Pulse=function(step){};function ADSR(attackLength,decayLength,sustainLevel,sustainLength,releaseLength,sampleRate){this.sampleRate=sampleRate;this.attackLength=attackLength;this.decayLength=decayLength;this.sustainLevel=sustainLevel;this.sustainLength=sustainLength;this.releaseLength=releaseLength;this.sampleRate=sampleRate;this.attackSamples=attackLength*sampleRate;this.decaySamples=decayLength*sampleRate;this.sustainSamples=sustainLength*sampleRate;this.releaseSamples=releaseLength*sampleRate;this.update=function(){this.attack=this.attackSamples;this.decay=this.attack+this.decaySamples;this.sustain=this.decay+this.sustainSamples;this.release=this.sustain+this.releaseSamples};this.update();this.samplesProcessed=0}ADSR.prototype.noteOn=function(){this.samplesProcessed=0;this.sustainSamples=this.sustainLength*this.sampleRate;this.update()};ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples;this.update()};ADSR.prototype.processSample=function(sample){var amplitude=0;if(this.samplesProcessed<=this.attack){amplitude=0+(1-0)*((this.samplesProcessed-0)/(this.attack-0))}else if(this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay){amplitude=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack))}else if(this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain){amplitude=this.sustainLevel}else if(this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release){amplitude=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))}return sample*amplitude};ADSR.prototype.value=function(){var amplitude=0;if(this.samplesProcessed<=this.attack){amplitude=0+(1-0)*((this.samplesProcessed-0)/(this.attack-0))}else if(this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay){amplitude=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack))}else if(this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain){amplitude=this.sustainLevel}else if(this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release){amplitude=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))}return amplitude};ADSR.prototype.process=function(buffer){for(var i=0;i<buffer.length;i++){buffer[i]*=this.value();this.samplesProcessed++}return buffer};ADSR.prototype.isActive=function(){if(this.samplesProcessed>this.release||this.samplesProcessed===-1){return false}else{return true}};ADSR.prototype.disable=function(){this.samplesProcessed=-1};function IIRFilter(type,cutoff,resonance,sampleRate){this.sampleRate=sampleRate;switch(type){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(cutoff,resonance,sampleRate);break}}IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff});IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance});IIRFilter.prototype.set=function(cutoff,resonance){this.func.calcCoeff(cutoff,resonance)};IIRFilter.prototype.process=function(buffer){this.func.process(buffer)};IIRFilter.prototype.addEnvelope=function(envelope){if(envelope instanceof ADSR){this.func.addEnvelope(envelope)}else{throw"Not an envelope."}};IIRFilter.LP12=function(cutoff,resonance,sampleRate){this.sampleRate=sampleRate;this.vibraPos=0;this.vibraSpeed=0;this.envelope=false;this.calcCoeff=function(cutoff,resonance){this.w=2*Math.PI*cutoff/this.sampleRate;this.q=1-this.w/(2*(resonance+.5/(1+this.w))+this.w-2);this.r=this.q*this.q;this.c=this.r+1-2*Math.cos(this.w)*this.q;this.cutoff=cutoff;this.resonance=resonance};this.calcCoeff(cutoff,resonance);this.process=function(buffer){for(var i=0;i<buffer.length;i++){this.vibraSpeed+=(buffer[i]-this.vibraPos)*this.c;this.vibraPos+=this.vibraSpeed;this.vibraSpeed*=this.r;if(this.envelope){buffer[i]=buffer[i]*(1-this.envelope.value())+this.vibraPos*this.envelope.value();this.envelope.samplesProcessed++}else{buffer[i]=this.vibraPos}}}};IIRFilter.LP12.prototype.addEnvelope=function(envelope){this.envelope=envelope};function IIRFilter2(type,cutoff,resonance,sampleRate){this.type=type;this.cutoff=cutoff;this.resonance=resonance;this.sampleRate=sampleRate;this.f=Float64Array(4);this.f[0]=0;this.f[1]=0;this.f[2]=0;this.f[3]=0;this.calcCoeff=function(cutoff,resonance){this.freq=2*Math.sin(Math.PI*Math.min(.25,cutoff/(this.sampleRate*2)));this.damp=Math.min(2*(1-Math.pow(resonance,.25)),Math.min(2,2/this.freq-this.freq*.5))};this.calcCoeff(cutoff,resonance)}IIRFilter2.prototype.process=function(buffer){var input,output;var f=this.f;for(var i=0;i<buffer.length;i++){input=buffer[i];f[3]=input-this.damp*f[2];f[0]=f[0]+this.freq*f[2];f[1]=f[3]-f[0];f[2]=this.freq*f[1]+f[2];output=.5*f[this.type];f[3]=input-this.damp*f[2];f[0]=f[0]+this.freq*f[2];f[1]=f[3]-f[0];f[2]=this.freq*f[1]+f[2];output+=.5*f[this.type];if(this.envelope){buffer[i]=buffer[i]*(1-this.envelope.value())+output*this.envelope.value();this.envelope.samplesProcessed++}else{buffer[i]=output}}};IIRFilter2.prototype.addEnvelope=function(envelope){if(envelope instanceof ADSR){this.envelope=envelope}else{throw"This is not an envelope."}};IIRFilter2.prototype.set=function(cutoff,resonance){this.calcCoeff(cutoff,resonance)};function WindowFunction(type,alpha){this.alpha=alpha;switch(type){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman;this.alpha=this.alpha||.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss;this.alpha=this.alpha||.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular;break}}WindowFunction.prototype.process=function(buffer){var length=buffer.length;for(var i=0;i<length;i++){buffer[i]*=this.func(length,i,this.alpha)}return buffer};WindowFunction.Bartlett=function(length,index){return 2/(length-1)*((length-1)/2-Math.abs(index-(length-1)/2))};WindowFunction.BartlettHann=function(length,index){return.62-.48*Math.abs(index/(length-1)-.5)-.38*Math.cos(DSP.TWO_PI*index/(length-1))};WindowFunction.Blackman=function(length,index,alpha){var a0=(1-alpha)/2;var a1=.5;var a2=alpha/2;return a0-a1*Math.cos(DSP.TWO_PI*index/(length-1))+a2*Math.cos(4*Math.PI*index/(length-1))};WindowFunction.Cosine=function(length,index){return Math.cos(Math.PI*index/(length-1)-Math.PI/2)};WindowFunction.Gauss=function(length,index,alpha){return Math.pow(Math.E,-.5*Math.pow((index-(length-1)/2)/(alpha*(length-1)/2),2))};WindowFunction.Hamming=function(length,index){return.54-.46*Math.cos(DSP.TWO_PI*index/(length-1))};WindowFunction.Hann=function(length,index){return.5*(1-Math.cos(DSP.TWO_PI*index/(length-1)))};WindowFunction.Lanczos=function(length,index){var x=2*index/(length-1)-1;return Math.sin(Math.PI*x)/(Math.PI*x)};WindowFunction.Rectangular=function(length,index){return 1};WindowFunction.Triangular=function(length,index){return 2/length*(length/2-Math.abs(index-(length-1)/2))};function sinh(arg){return(Math.exp(arg)-Math.exp(-arg))/2}function Biquad(type,sampleRate){this.Fs=sampleRate;this.type=type;this.parameterType=DSP.Q;this.x_1_l=0;this.x_2_l=0;this.y_1_l=0;this.y_2_l=0;this.x_1_r=0;this.x_2_r=0;this.y_1_r=0;this.y_2_r=0;this.b0=1;this.a0=1;this.b1=0;this.a1=0;this.b2=0;this.a2=0;this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0;this.f0=3e3;this.dBgain=12;this.Q=1;this.BW=-3;this.S=1;this.coefficients=function(){var b=[this.b0,this.b1,this.b2];var a=[this.a0,this.a1,this.a2];return{b:b,a:a}};this.setFilterType=function(type){this.type=type;this.recalculateCoefficients()};this.setSampleRate=function(rate){this.Fs=rate;this.recalculateCoefficients()};this.setQ=function(q){this.parameterType=DSP.Q;this.Q=Math.max(Math.min(q,115),.001);this.recalculateCoefficients()};this.setBW=function(bw){this.parameterType=DSP.BW;this.BW=bw;this.recalculateCoefficients()};this.setS=function(s){this.parameterType=DSP.S;this.S=Math.max(Math.min(s,5),1e-4);this.recalculateCoefficients()};this.setF0=function(freq){this.f0=freq;this.recalculateCoefficients()};this.setDbGain=function(g){this.dBgain=g;this.recalculateCoefficients()};this.recalculateCoefficients=function(){var A;if(type===DSP.PEAKING_EQ||type===DSP.LOW_SHELF||type===DSP.HIGH_SHELF){A=Math.pow(10,this.dBgain/40)}else{A=Math.sqrt(Math.pow(10,this.dBgain/20))}var w0=DSP.TWO_PI*this.f0/this.Fs;var cosw0=Math.cos(w0);var sinw0=Math.sin(w0);var alpha=0;switch(this.parameterType){case DSP.Q:alpha=sinw0/(2*this.Q);break;case DSP.BW:alpha=sinw0*sinh(Math.LN2/2*this.BW*w0/sinw0);break;case DSP.S:alpha=sinw0/2*Math.sqrt((A+1/A)*(1/this.S-1)+2);break}var coeff;switch(this.type){case DSP.LPF:this.b0=(1-cosw0)/2;this.b1=1-cosw0;this.b2=(1-cosw0)/2;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.HPF:this.b0=(1+cosw0)/2;this.b1=-(1+cosw0);this.b2=(1+cosw0)/2;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=sinw0/2;this.b1=0;this.b2=-sinw0/2;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.BPF_CONSTANT_PEAK:this.b0=alpha;this.b1=0;this.b2=-alpha;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.NOTCH:this.b0=1;this.b1=-2*cosw0;this.b2=1;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.APF:this.b0=1-alpha;this.b1=-2*cosw0;this.b2=1+alpha;this.a0=1+alpha;this.a1=-2*cosw0;this.a2=1-alpha;break;case DSP.PEAKING_EQ:this.b0=1+alpha*A;this.b1=-2*cosw0;this.b2=1-alpha*A;this.a0=1+alpha/A;this.a1=-2*cosw0;this.a2=1-alpha/A;break;case DSP.LOW_SHELF:coeff=sinw0*Math.sqrt((A^2+1)*(1/this.S-1)+2*A);this.b0=A*(A+1-(A-1)*cosw0+coeff);this.b1=2*A*(A-1-(A+1)*cosw0);this.b2=A*(A+1-(A-1)*cosw0-coeff);this.a0=A+1+(A-1)*cosw0+coeff;this.a1=-2*(A-1+(A+1)*cosw0);this.a2=A+1+(A-1)*cosw0-coeff;break;case DSP.HIGH_SHELF:coeff=sinw0*Math.sqrt((A^2+1)*(1/this.S-1)+2*A);this.b0=A*(A+1+(A-1)*cosw0+coeff);this.b1=-2*A*(A-1+(A+1)*cosw0);this.b2=A*(A+1+(A-1)*cosw0-coeff);this.a0=A+1-(A-1)*cosw0+coeff;this.a1=2*(A-1-(A+1)*cosw0);this.a2=A+1-(A-1)*cosw0-coeff;break}this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0};this.process=function(buffer){var len=buffer.length;var output=new Float64Array(len);for(var i=0;i<buffer.length;i++){output[i]=this.b0a0*buffer[i]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l;this.y_2_l=this.y_1_l;this.y_1_l=output[i];this.x_2_l=this.x_1_l;this.x_1_l=buffer[i]}return output};this.processStereo=function(buffer){var len=buffer.length;var output=new Float64Array(len);for(var i=0;i<len/2;i++){output[2*i]=this.b0a0*buffer[2*i]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l;this.y_2_l=this.y_1_l;this.y_1_l=output[2*i];this.x_2_l=this.x_1_l;this.x_1_l=buffer[2*i];output[2*i+1]=this.b0a0*buffer[2*i+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r;this.y_2_r=this.y_1_r;this.y_1_r=output[2*i+1];this.x_2_r=this.x_1_r;this.x_1_r=buffer[2*i+1]}return output}}DSP.mag2db=function(buffer){var minDb=-120;var minMag=Math.pow(10,minDb/20);var log=Math.log;var max=Math.max;var result=Float64Array(buffer.length);for(var i=0;i<buffer.length;i++){result[i]=20*log(max(buffer[i],minMag))}return result};DSP.freqz=function(b,a,w){var i,j;if(!w){w=Float64Array(200);for(i=0;i<w.length;i++){w[i]=DSP.TWO_PI/w.length*i-Math.PI}}var result=Float64Array(w.length);var sqrt=Math.sqrt;var cos=Math.cos;var sin=Math.sin;for(i=0;i<w.length;i++){var numerator={real:0,imag:0};for(j=0;j<b.length;j++){numerator.real+=b[j]*cos(-j*w[i]);numerator.imag+=b[j]*sin(-j*w[i])}var denominator={real:0,imag:0};for(j=0;j<a.length;j++){denominator.real+=a[j]*cos(-j*w[i]);denominator.imag+=a[j]*sin(-j*w[i])}result[i]=sqrt(numerator.real*numerator.real+numerator.imag*numerator.imag)/sqrt(denominator.real*denominator.real+denominator.imag*denominator.imag)}return result};function GraphicalEq(sampleRate){this.FS=sampleRate;this.minFreq=40;this.maxFreq=16e3;this.bandsPerOctave=1;this.filters=[];this.freqzs=[];this.calculateFreqzs=true;this.recalculateFilters=function(){var bandCount=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var i=0;i<bandCount;i++){var freq=this.minFreq*Math.pow(2,i/this.bandsPerOctave);var newFilter=new Biquad(DSP.PEAKING_EQ,this.FS);newFilter.setDbGain(0);newFilter.setBW(1/this.bandsPerOctave);newFilter.setF0(freq);this.filters[i]=newFilter;this.recalculateFreqz(i)}};this.setMinimumFrequency=function(freq){this.minFreq=freq;this.recalculateFilters()};this.setMaximumFrequency=function(freq){this.maxFreq=freq;this.recalculateFilters()};this.setBandsPerOctave=function(bands){this.bandsPerOctave=bands;this.recalculateFilters()};this.setBandGain=function(bandIndex,gain){if(bandIndex<0||bandIndex>this.filters.length-1){throw"The band index of the graphical equalizer is out of bounds."}if(!gain){throw"A gain must be passed."}this.filters[bandIndex].setDbGain(gain);this.recalculateFreqz(bandIndex)};this.recalculateFreqz=function(bandIndex){if(!this.calculateFreqzs){return}if(bandIndex<0||bandIndex>this.filters.length-1){throw"The band index of the graphical equalizer is out of bounds. "+bandIndex+" is out of ["+0+", "+this.filters.length-1+"]"}if(!this.w){this.w=Float64Array(400);for(var i=0;i<this.w.length;i++){this.w[i]=Math.PI/this.w.length*i}}var b=[this.filters[bandIndex].b0,this.filters[bandIndex].b1,this.filters[bandIndex].b2];var a=[this.filters[bandIndex].a0,this.filters[bandIndex].a1,this.filters[bandIndex].a2];this.freqzs[bandIndex]=DSP.mag2db(DSP.freqz(b,a,this.w))};this.process=function(buffer){var output=buffer;for(var i=0;i<this.filters.length;i++){output=this.filters[i].process(output)}return output};this.processStereo=function(buffer){var output=buffer;for(var i=0;i<this.filters.length;i++){output=this.filters[i].processStereo(output)}return output}}function MultiDelay(maxDelayInSamplesSize,delayInSamples,masterVolume,delayVolume){this.delayBufferSamples=new Float64Array(maxDelayInSamplesSize);this.delayInputPointer=delayInSamples;this.delayOutputPointer=0;this.delayInSamples=delayInSamples;this.masterVolume=masterVolume;this.delayVolume=delayVolume}MultiDelay.prototype.setDelayInSamples=function(delayInSamples){this.delayInSamples=delayInSamples;this.delayInputPointer=this.delayOutputPointer+delayInSamples;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length}};MultiDelay.prototype.setMasterVolume=function(masterVolume){this.masterVolume=masterVolume};MultiDelay.prototype.setDelayVolume=function(delayVolume){this.delayVolume=delayVolume};MultiDelay.prototype.process=function(samples){var outputSamples=new Float64Array(samples.length);for(var i=0;i<samples.length;i++){var delaySample=this.delayBufferSamples[this.delayOutputPointer]===null?0:this.delayBufferSamples[this.delayOutputPointer];var sample=delaySample*this.delayVolume+samples[i];this.delayBufferSamples[this.delayInputPointer]=sample;outputSamples[i]=sample*this.masterVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=0}this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-1){this.delayOutputPointer=0}}return outputSamples};function SingleDelay(maxDelayInSamplesSize,delayInSamples,delayVolume){this.delayBufferSamples=new Float64Array(maxDelayInSamplesSize);this.delayInputPointer=delayInSamples;this.delayOutputPointer=0;this.delayInSamples=delayInSamples;this.delayVolume=delayVolume}SingleDelay.prototype.setDelayInSamples=function(delayInSamples){this.delayInSamples=delayInSamples;this.delayInputPointer=this.delayOutputPointer+delayInSamples;if(this.delayInputPointer>=this.delayBufferSamples.length-1){
this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length}};SingleDelay.prototype.setDelayVolume=function(delayVolume){this.delayVolume=delayVolume};SingleDelay.prototype.process=function(samples){var outputSamples=new Float64Array(samples.length);for(var i=0;i<samples.length;i++){this.delayBufferSamples[this.delayInputPointer]=samples[i];var delaySample=this.delayBufferSamples[this.delayOutputPointer];outputSamples[i]=delaySample*this.delayVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=0}this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-1){this.delayOutputPointer=0}}return outputSamples};function Reverb(maxDelayInSamplesSize,delayInSamples,masterVolume,mixVolume,delayVolume,dampFrequency){this.delayInSamples=delayInSamples;this.masterVolume=masterVolume;this.mixVolume=mixVolume;this.delayVolume=delayVolume;this.dampFrequency=dampFrequency;this.NR_OF_MULTIDELAYS=6;this.NR_OF_SINGLEDELAYS=6;this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,dampFrequency,0,44100);this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,dampFrequency,0,44100);this.singleDelays=[];var i,delayMultiply;for(i=0;i<this.NR_OF_SINGLEDELAYS;i++){delayMultiply=1+i/7;this.singleDelays[i]=new SingleDelay(maxDelayInSamplesSize,Math.round(this.delayInSamples*delayMultiply),this.delayVolume)}this.multiDelays=[];for(i=0;i<this.NR_OF_MULTIDELAYS;i++){delayMultiply=1+i/10;this.multiDelays[i]=new MultiDelay(maxDelayInSamplesSize,Math.round(this.delayInSamples*delayMultiply),this.masterVolume,this.delayVolume)}}Reverb.prototype.setDelayInSamples=function(delayInSamples){this.delayInSamples=delayInSamples;var i,delayMultiply;for(i=0;i<this.NR_OF_SINGLEDELAYS;i++){delayMultiply=1+i/7;this.singleDelays[i].setDelayInSamples(Math.round(this.delayInSamples*delayMultiply))}for(i=0;i<this.NR_OF_MULTIDELAYS;i++){delayMultiply=1+i/10;this.multiDelays[i].setDelayInSamples(Math.round(this.delayInSamples*delayMultiply))}};Reverb.prototype.setMasterVolume=function(masterVolume){this.masterVolume=masterVolume};Reverb.prototype.setMixVolume=function(mixVolume){this.mixVolume=mixVolume};Reverb.prototype.setDelayVolume=function(delayVolume){this.delayVolume=delayVolume;var i;for(i=0;i<this.NR_OF_SINGLEDELAYS;i++){this.singleDelays[i].setDelayVolume(this.delayVolume)}for(i=0;i<this.NR_OF_MULTIDELAYS;i++){this.multiDelays[i].setDelayVolume(this.delayVolume)}};Reverb.prototype.setDampFrequency=function(dampFrequency){this.dampFrequency=dampFrequency;this.LOWPASSL.set(dampFrequency,0);this.LOWPASSR.set(dampFrequency,0)};Reverb.prototype.process=function(interleavedSamples){var outputSamples=new Float64Array(interleavedSamples.length);var leftRightMix=DSP.deinterleave(interleavedSamples);this.LOWPASSL.process(leftRightMix[DSP.LEFT]);this.LOWPASSR.process(leftRightMix[DSP.RIGHT]);var filteredSamples=DSP.interleave(leftRightMix[DSP.LEFT],leftRightMix[DSP.RIGHT]);var i;for(i=0;i<this.NR_OF_MULTIDELAYS;i++){outputSamples=DSP.mixSampleBuffers(outputSamples,this.multiDelays[i].process(filteredSamples),2%i===0,this.NR_OF_MULTIDELAYS)}var singleDelaySamples=new Float64Array(outputSamples.length);for(i=0;i<this.NR_OF_SINGLEDELAYS;i++){singleDelaySamples=DSP.mixSampleBuffers(singleDelaySamples,this.singleDelays[i].process(outputSamples),2%i===0,1)}for(i=0;i<singleDelaySamples.length;i++){singleDelaySamples[i]*=this.mixVolume}outputSamples=DSP.mixSampleBuffers(singleDelaySamples,interleavedSamples,0,1);for(i=0;i<outputSamples.length;i++){outputSamples[i]*=this.masterVolume}return outputSamples};if(module&&typeof module.exports!=="undefined"){module.exports={DSP:DSP,DFT:DFT,FFT:FFT,RFFT:RFFT,Sampler:Sampler,Oscillator:Oscillator,ADSR:ADSR,IIRFilter:IIRFilter,IIRFilter2:IIRFilter2,WindowFunction:WindowFunction,sinh:sinh,Biquad:Biquad,GraphicalEq:GraphicalEq,MultiDelay:MultiDelay,SingleDelay:SingleDelay,Reverb:Reverb}}},{}],2:[function(require,module,exports){var code="";exports.codeset=function(codeString){code=codeString};exports.codeget=function(){return code};exports.run=function(){eval.call(null,code)}},{}],3:[function(require,module,exports){exports.defaultPalette=function(){return[0,1911635,8267091,34641,11227702,6248271,12764103,16773608,16711757,16753408,16773156,59222,2731519,8615580,16742312,16764074]};exports.int2hex=function(int){var hex=int.toString(16);while(hex.length<6){hex="0"+hex}hex="#"+hex;return hex}},{}],4:[function(require,module,exports){var utils=require("./utils");var coloredFontCanvases=[];var coloredSpecialCharsCanvases=[];var fontX=4;var fontY=5;var paletteHex=[];var chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,^?()[]:/\\="a+-!{}<>;_|&*~%#';var specialChars="";var dirty=true;exports.init=function(palHex){exports.changePalette(palHex)};exports.changePalette=function(palHex){paletteHex=palHex.slice();dirty=true};function redrawCanvases(){var backgroundColor=[0,0,0,0];for(var i=0;i<paletteHex.length;i++){var rgba=utils.hexToRgb(paletteHex[i]);rgba[3]=255;var colorMap={"#":rgba," ":backgroundColor};coloredFontCanvases[i]=utils.createCanvasFromAscii(["### ###  ## ##  ### ###  ## # # ### ### # # #   ### ##   ## ###  #  ###  ## ### # # # # # # # # # # ### ### ##  ### ### # # ### #   ### ### ###          #  ###  #   #  ##   ##       # #       # #  #           #   ## ##    # #            #   ## # #     # # # #","# # # # #   # # #   #   #   # #  #   #  # # #   ### # # # # # # # # # # #    #  # # # # # # # # # #   # # #  #    #   # # # #   #     # # # # #         # #   # #     # #     #  #   #   #  ### # # #    #       #   #   #   #   #    #      #  #    #    #   # ###","### ##  #   # # ##  ##  #   ###  #   #  ##  #   # # # # # # ### # # ##  ###  #  # # # # # #  #  ###  #  # #  #  ###  ## ### ### ###   # ### ###              ## #     # #     #      #   #              ### ###  #  #     # #     #          #   #  ### ###  #  # #","# # # # #   # # #   #   # # # #  #   #  # # #   # # # # # # #   ##  # #   #  #  # # ### ### # #   # #   # #  #  #     #   #   # # #   # # #   #      #          #     # #     #  #   #   #  ###          #           #   #   #   #    #      #  # #  #  #   #   ###","# # ###  ## ### ### #   ### # # ### ##  # # ### # # # # ##  #    ## # # ##   #   ##  #  ### # # ### ### ### ### ### ###   # ### ###   # ###   #  #  #        #   #   #  ##   ##     #     #                      #   ## ##    # #    #  ###  #  ### # #     # # # #"],colorMap);coloredSpecialCharsCanvases[i]=utils.createCanvasFromAscii(["####### # # # # #     #  #####  #   #     #       ###    ## ##    ###     ###     ###    #####  #######    ###   #####     #             #####     #     #####   #####                   #####  ####### # # # # ","#######  # # #  ####### ##   ##   #   #   ####   ### #   #####   ## ##    ###    #####  ###  ## # ### #    #    ##   ##   ###           ##  ###   ###     ###   ### ### # #     #   #   ## # ##         # # # # ","####### # # # # # ### # ##   ## #   #     ###    #####   #####  ### ###  #####  ####### ##   ## #######    #    ## # ##  #####  # # # # ##   ## #######    #    ##   ##  #  # #  # # #  ### ### ####### # # # # ","#######  # # #  # ### # ### ###   #   #  ####    #####    ###    ## ##    ###    # # #  ###  ## #     #  ###    ##   ##   ###           ##  ###  #####    ###   ##   ##      #    #   # ## # ##         # # # # ","####### # # # #  #####   #####  #   #       #     ###      #      ###     # #    # ###   #####  #######  ###     #####     #             #####   #   #   #####   #####                   #####  ####### # # # # "],colorMap)}}exports.draw=function(ctx,text,x,y,col){if(dirty){redrawCanvases();dirty=false}var position=0;for(var i=0;i<text.length;i++){var index=chars.indexOf(text[i]);if(index!==-1){ctx.drawImage(coloredFontCanvases[col],index*fontX,0,fontX,fontY,x+fontX*position,y,fontX,fontY)}else if((index=specialChars.indexOf(text[i]))!==-1){ctx.drawImage(coloredSpecialCharsCanvases[col],index*fontX*2,0,fontX*2,fontY,x+fontX*position,y,fontX*2,fontY);position++}position++}}},{"./utils":13}],5:[function(require,module,exports){exports.hello=function(){console.log(["CARTRIDGE.JS","JavaScript retro game engine.","","For help, run help()."].join("\n"))};exports.print=function(){console.log(["fullscreen()      Enable full screen.","help()            Print this message.",'load("name")      Load sprites and map from localStorage.','save("name")      Save sprites and map to localStorage.','save("name.json") Download the contents to a JSON file.'].join("\n"))}},{}],6:[function(require,module,exports){var help=require("./help");var input=require("./input");var mouse=require("./mouse");var utils=require("./utils");var font=require("./font");var math=require("./math");var colors=require("./colors");var sfx=require("./sfx");var pixelops=require("./pixelops");var code=require("./code");var music=require("./music");var cellsizeX=8;var cellsizeY=8;var screensizeX=128;var screensizeY=128;var mapSizeX=128;var mapSizeY=32;var spriteSheetSizeX=16;var spriteSheetSizeY=16;var paletteSize=16;var container;var canvases=[];var canvasListeners;var bodyListeners;var mapData=utils.zeros(mapSizeX*mapSizeY);var mapDataDirty=utils.zeros(mapSizeX*mapSizeY);var mapDirty=true;var mapCacheCanvas;var mapCacheContext;var spriteSheetCanvas;var spriteSheetContext;var spriteSheetDirty=false;var spriteFlags;var spriteSheetPixels;var ctx;var _time=0;var _startTime=0;var camX=0;var camY=0;var palette;var paletteHex;var defaultColor=0;var transparentColors=utils.zeros(paletteSize).map(function(){return false});transparentColors[0]=true;var loaded=false;var _alpha=0;var pixelPerfectMode=0;var autoFit=false;exports.cartridge=function(options){autoFit=options.autoFit!==undefined?options.autoFit:true;pixelPerfectMode=options.pixelPerfect!==undefined?options.pixelPerfect:0;var numCanvases=options.layers!==undefined?options.layers:1;container=options.containerId?document.getElementById(options.containerId):null;var html="";for(var i=0;i<numCanvases;i++){html+='<canvas class="cartridgeCanvas" id="cartridgeCanvas'+i+'" width="'+screensizeX+'" height="'+screensizeY+'"'+(i===0?" moz-opaque":"")+"></canvas>"}container.innerHTML=html;for(var i=0;i<numCanvases;i++){var c=document.getElementById("cartridgeCanvas"+i);c.oncontextmenu=function(){return false};canvases.push(c);if(i!==0){c.style.pointerEvents="none"}c.style.position="absolute";utils.disableImageSmoothing(c.getContext("2d"))}setCellSize(cellsizeX,cellsizeY,spriteSheetSizeX,spriteSheetSizeY);setPalette(options.palette||colors.defaultPalette());var style=document.createElement("style");style.innerHTML=[".cartridgeCanvas {","image-rendering: -moz-crisp-edges;","image-rendering: -webkit-crisp-edges;","image-rendering: pixelated;","}"].join("\n");document.getElementsByTagName("head")[0].appendChild(style);canvas(0);input.init(canvases);mouse.init(canvases);pixelops.init(canvases[0]);if(autoFit){fit(pixelPerfectMode);var resizeHandler=function(){fit(pixelPerfectMode)};window.addEventListener("resize",resizeHandler);window.addEventListener("mozfullscreenchange",resizeHandler)}var currentTime=0;var t0=0;var t1=0;var dt0=Math.floor(1/30*1e3);var dt1=Math.floor(1/60*1e3);var accumulator0=0;var accumulator1=0;function render(newTime){if(currentTime){var frameTime=newTime-currentTime;if(frameTime>250)frameTime=250;accumulator0+=frameTime;while(accumulator0>=dt0){_time=t0;t0+=dt0;accumulator0-=dt0;_alpha=accumulator0/dt0;if(loaded&&typeof _update==="function"){runUserFunction(_update)}}accumulator1+=frameTime;while(accumulator1>=dt1){_time=t1;t1+=dt1;accumulator1-=dt1;_alpha=accumulator1/dt1;if(loaded&&typeof _update60==="function"){runUserFunction(_update60)}}}if(_startTime===-1){_startTime=newTime}_time=newTime-_startTime;if(loaded&&typeof _draw==="function"){runUserFunction(_draw)}pixelops.flush();currentTime=newTime;input.update();requestAnimationFrame(render)}requestAnimationFrame(render);font.init(paletteHex)};exports.run=function(){if(loaded){runKill()}_startTime=-1;try{code.run()}catch(err){if(typeof _error==="function"){_error(createErrorObject(err))}}runInit()};function runInit(){loaded=true;if(typeof _init==="function"){runUserFunction(_init)}}function runKill(){loaded=false;if(typeof _kill==="function"){runUserFunction(_kill)}}function setCellSize(newCellWidth,newCellHeight,newSpriteSheetWidth,newSpriteSheetHeight){newCellWidth=newCellWidth|0;newCellHeight=newCellHeight|0;newSpriteSheetWidth=newSpriteSheetWidth|0;newSpriteSheetHeight=newSpriteSheetHeight|0;var newSpriteSheetPixels=utils.zeros(newSpriteSheetWidth*newSpriteSheetHeight*newCellWidth*newCellHeight);if(spriteSheetPixels){var minWidth=Math.min(spriteSheetSizeX*cellsizeX,newSpriteSheetWidth*newCellWidth);var minHeight=Math.min(spriteSheetSizeY*cellsizeY,newSpriteSheetHeight*newCellHeight);for(var i=0;i<minWidth;i++){for(var j=0;j<minHeight;j++){newSpriteSheetPixels[i+j*newSpriteSheetWidth*newCellWidth]=spriteSheetPixels[i+j*spriteSheetSizeX*cellsizeX]}}}spriteSheetPixels=newSpriteSheetPixels;for(var i=0;i<mapSizeX;i++){for(var j=0;j<mapSizeY;j++){var oldSpriteIndex=mget(i,j);var oldX=ssx(oldSpriteIndex);var oldY=ssy(oldSpriteIndex);var newSpriteIndex=oldX+oldY*newSpriteSheetWidth;if(newSpriteIndex>=newSpriteSheetWidth*newSpriteSheetHeight)continue;mset(i,j,newSpriteIndex)}}cellsizeX=newCellWidth;cellsizeY=newCellHeight;spriteSheetSizeX=newSpriteSheetWidth;spriteSheetSizeY=newSpriteSheetHeight;var maxSprites=spriteSheetSizeX*spriteSheetSizeY;if(!spriteFlags)spriteFlags=utils.zeros(maxSprites);while(spriteFlags.length<maxSprites)spriteFlags.push(0);while(spriteFlags.length>maxSprites)spriteFlags.pop();spriteSheetCanvas=utils.createCanvas(spriteSheetSizeX*cellsizeX,spriteSheetSizeY*cellsizeY);spriteSheetContext=spriteSheetCanvas.getContext("2d");mapCacheCanvas=utils.createCanvas(mapSizeX*cellsizeX,mapSizeY*cellsizeY);mapCacheContext=mapCacheCanvas.getContext("2d");spriteSheetDirty=true;mapDirty=true}function redrawSpriteSheet(){var w=spriteSheetSizeX*cellsizeX;var h=spriteSheetSizeY*cellsizeY;for(var i=0;i<w;i++){for(var j=0;j<h;j++){redrawSpriteSheetPixel(i,j)}}spriteSheetDirty=false}function redrawSpriteSheetPixel(x,y){var w=spriteSheetSizeX*cellsizeX;var h=spriteSheetSizeY*cellsizeY;var col=spriteSheetPixels[y*w+x];if(transparentColors[col]){spriteSheetContext.clearRect(x,y,1,1)}else{spriteSheetContext.fillStyle=paletteHex[col%palette.length];spriteSheetContext.fillRect(x,y,1,1)}}function setPalette(p){palette=p.slice(0);paletteHex=palette.map(colors.int2hex);mapDirty=true;spriteSheetDirty=true;font.changePalette(paletteHex)}exports.palset=function(n,hexColor){var newPalette=palette.slice(0);while(newPalette.length<n)newPalette.push(0);newPalette[n]=hexColor;setPalette(newPalette)};exports.palget=function(n){return palette[n]};function resizeCanvases(){for(var i=0;i<canvases.length;i++){canvases[i].width=screensizeX;canvases[i].height=screensizeY}if(autoFit){fit(pixelPerfectMode)}pixelops.resize(canvases[0])}exports.alpha=function(){return _alpha};exports.width=function(newWidth){if(newWidth!==undefined){screensizeX=newWidth|0;resizeCanvases()}return screensizeX};exports.height=function(newHeight){if(newHeight!==undefined){screensizeY=newHeight|0;resizeCanvases()}return screensizeY};exports.cellwidth=function(newCellWidth){if(newCellWidth!==undefined){setCellSize(newCellWidth,cellsizeY,spriteSheetSizeX,spriteSheetSizeY)}else{return cellsizeX}};exports.cellheight=function(newCellHeight){if(newCellHeight!==undefined){setCellSize(cellsizeX,newCellHeight,spriteSheetSizeX,spriteSheetSizeY)}else{return cellsizeY}};exports.cls=function(){pixelops.beforeChange();ctx.clearRect(-camX,-camY,screensizeX,screensizeY)};exports.time=function(){return _time/1e3};exports.color=function(col){defaultColor=col};exports.palt=function(col,t){if(t!==undefined){transparentColors[col]=t}else{return transparentColors[col]}};exports.rectfill=function rectfill(x0,y0,x1,y1,col){pixelops.beforeChange();x0=x0|0;y0=y0|0;x1=x1|0;y1=y1|0;col=col!==undefined?col:defaultColor;var w=x1-x0+1;var h=y1-y0+1;ctx.fillStyle=paletteHex[col];ctx.fillRect(x0,y0,w,h)};exports.rect=function rect(x0,y0,x1,y1,col){pixelops.beforeChange();x0=x0|0;y0=y0|0;x1=x1|0;y1=y1|0;col=col!==undefined?col:defaultColor;var w=x1-x0;var h=y1-y0;ctx.fillStyle=paletteHex[col];ctx.fillRect(x0,y0,w,1);ctx.fillRect(x0,y0,1,h);ctx.fillRect(x1,y0,1,h+1);ctx.fillRect(x0,y1,w+1,1)};exports.clip=function(x,y,w,h){x=x|0;y=y|0;w=w|0;h=h|0;ctx.rect(x,y,w,h);ctx.clip()};exports.canvas=function canvas(n){ctx=canvases[n].getContext("2d")};exports.camera=function camera(x,y){x=x|0;y=y|0;if(camX===x&&camY===y)return;pixelops.beforeChange();ctx.translate(x-camX,y-camY);camX=x;camY=y};exports.map=function map(cel_x,cel_y,sx,sy,cel_w,cel_h,layer){pixelops.beforeChange();layer=layer===undefined?0:layer;cel_x=cel_x|0;cel_y=cel_y|0;sx=sx|0;sy=sy|0;cel_w=cel_w|0;cel_h=cel_h|0;var i,j;if(layer===0){if(mapDirty){for(i=0;i<mapSizeX;i++){for(j=0;j<mapSizeY;j++){updateMapCacheCanvas(i,j)}}mapDirty=false}for(i=0;i<mapSizeX;i++){for(j=0;j<mapSizeY;j++){if(mapDataDirty[j*mapSizeX+i]){updateMapCacheCanvas(i,j);mapDataDirty[j*mapSizeX+i]=0}}}var _sx=cel_x*cellsizeX;var _sy=cel_y*cellsizeY;var _x=sx;var _y=sy;var _swidth=cel_w*cellsizeX;var _sheight=cel_h*cellsizeY;var _width=_swidth;var _height=_sheight;ctx.drawImage(mapCacheCanvas,_sx,_sy,_swidth,_sheight,_x,_y,_width,_height)}else{for(i=0;i<cel_w;i++){for(j=0;j<cel_h;j++){var spriteNumber=mget(i,j);var flags=fget(spriteNumber);if((layer&flags)===layer){spr(spriteNumber,sx+i*cellsizeX,sy+j*cellsizeY)}}}}};function ssx(n){return n%spriteSheetSizeX}function ssy(n){return Math.floor(n/spriteSheetSizeX)%(spriteSheetSizeX*spriteSheetSizeY)}exports.spr=function spr(n,x,y,w,h,flip_x,flip_y){pixelops.beforeChange();if(spriteSheetDirty)redrawSpriteSheet();w=w!==undefined?w:1;h=h!==undefined?h:1;flip_x=flip_x!==undefined?flip_x:false;flip_y=flip_y!==undefined?flip_y:false;x=x|0;y=y|0;w=w|0;h=h|0;var sizex=cellsizeX*w;var sizey=cellsizeY*h;ctx.save();ctx.translate(x+(flip_x?sizex:0),y+(flip_y?sizey:0));ctx.scale(flip_x?-1:1,flip_y?-1:1);ctx.drawImage(spriteSheetCanvas,ssx(n)*cellsizeX,ssy(n)*cellsizeY,sizex,sizey,0,0,sizex,sizey);ctx.restore()};exports.fget=function(n,bitPosition){var flags=spriteFlags[n];if(bitPosition!==undefined){return!!(flags&1<<bitPosition)}return flags};exports.fset=function(n,flags,t){var newFlags;if(t!==undefined){newFlags=spriteFlags[n];var bit=1<<flags;if(t){newFlags|=bit}else{newFlags&=~bit}}else{newFlags=flags}spriteFlags[n]=newFlags};exports.assert=function(condition,message){if(!condition){message=message!==undefined?message:"Assertion failed";throw new Error(message)}};exports.pget=function(){var data=new Uint8Array(3);return function(x,y){x=x|0;y=y|0;pixelops.pget(x,y,data);var col=utils.rgbToDec(data[0],data[1],data[2]);var result=palette.indexOf(col);return result===-1?0:result}}();exports.pset=function(x,y,col){x=x|0;y=y|0;col=col|0;var dec=palette[col];var r=utils.decToR(dec);var g=utils.decToG(dec);var b=utils.decToB(dec);pixelops.pset(x,y,r,g,b)};exports.sget=function(x,y){x=x|0;y=y|0;var w=spriteSheetSizeX*cellsizeX;return spriteSheetPixels[y*w+x]};exports.ssset=function(n){setCellSize(cellsizeX,cellsizeY,n,n)};exports.ssget=function(){return spriteSheetSizeX};exports.sset=function(x,y,col){x=x|0;y=y|0;col=col!==undefined?col:defaultColor;var w=spriteSheetSizeX*cellsizeX;spriteSheetPixels[y*w+x]=col;if(spriteSheetDirty)redrawSpriteSheet();redrawSpriteSheetPixel(x,y);mapDirty=true};exports.fullscreen=function fullscreen(){utils.fullscreen(container)};exports.def=function(x){return x!==undefined};exports.log=function(){console.log.apply(null,arguments)};exports.print=function(text,x,y,col){pixelops.beforeChange();if(Array.isArray(text)){for(var i=0;i<text.length;i++){exports.print(text[i],x,y+8*i,col)}return}x=x!==undefined?x:0;y=y!==undefined?y:0;col=col!==undefined?col:defaultColor;x=x|0;y=y|0;font.draw(ctx,text.toString().toUpperCase(),x,y,col)};exports.fit=function fit(stretchMode){stretchMode=stretchMode!==undefined?stretchMode:0;var pixelPerfect=stretchMode===0;var i=canvases.length;while(i--){utils.scaleToFit(canvases[i],container,pixelPerfect)}};exports.mget=function mget(x,y){x=x|0;y=y|0;return mapData[y*mapSizeX+x]};exports.mset=function mset(x,y,i){if(mget(x,y)===i)return;x=x|0;y=y|0;mapData[y*mapSizeX+x]=i;mapDataDirty[y*mapSizeX+x]=1};exports.save=function(key){key=key||"save";var data=toJSON();var idx=key.indexOf(".json");if(idx!==-1){download(key.substr(0,idx))}else{localStorage.setItem(key,JSON.stringify(data))}};exports.load=function(key){if(typeof key==="object"){loadJSON(key)}else{key=key||"save";if(key.indexOf(".json")!==-1){loadJsonFromUrl(key,function(err,json){if(json){loadJSON(json)}})}else{try{var data=JSON.parse(localStorage.getItem(key));loadJSON(data);return true}catch(err){return false}}}};function loadJsonFromUrl(url,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===XMLHttpRequest.DONE){if(xhr.status===200){callback(null,JSON.parse(xhr.responseText))}else{callback(xhr)}}};xhr.open("GET",url,true);xhr.send()}function download(key){key=key||"export";var data=toJSON();var url=URL.createObjectURL(new Blob([JSON.stringify(data)]));var a=document.createElement("a");a.href=url;a.download=key+".json";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}function toJSON(){var i,j;var data={version:5,width:width(),height:height(),cellwidth:cellwidth(),cellheight:cellheight(),spritesheetsize:ssget(),map:[],sprites:[],flags:[],palette:palette.slice(0),sfx:[],code:code.codeget()};for(var i=0;i<spriteFlags.length;i++){data.flags[i]=fget(i)}for(i=0;i<ssget()*cellwidth();i++){for(j=0;j<ssget()*cellheight();j++){data.sprites[j*ssget()*cellwidth()+i]=sget(i,j)}}while(data.sprites[data.sprites.length-1]===0){data.sprites.pop()}for(i=0;i<mapSizeX;i++){for(j=0;j<mapSizeY;j++){data.map[j*mapSizeX+i]=mget(i,j)}}while(data.map[data.map.length-1]===0){data.map.pop()}for(var n=0;n<64;n++){data.sfx[n]={speed:asget(n),volumes:[],pitches:[],waves:[]};for(var offset=0;offset<32;offset++){data.sfx[n].volumes.push(avget(n,offset));data.sfx[n].pitches.push(afget(n,offset));data.sfx[n].waves.push(awget(n,offset))}}return data}function loadJSON(data){var i,j;code.codeset(data.code||"");if(data.width!==undefined){width(data.width)}if(data.height!==undefined){height(data.height)}if(data.cellwidth!==undefined){cellwidth(data.cellwidth)}if(data.cellheight!==undefined){cellheight(data.cellheight)}if(data.spritesheetsize!==undefined){ssset(data.spritesheetsize)}for(i=0;i<spriteFlags.length;i++){fset(i,data.flags[i])}setPalette(data.palette);for(i=0;i<spriteSheetSizeX*cellwidth();i++){for(j=0;j<spriteSheetSizeY*cellheight();j++){sset(i,j,data.sprites[j*spriteSheetSizeX*cellwidth()+i]||0)}}for(i=0;i<mapSizeX;i++){for(j=0;j<mapSizeY;j++){mset(i,j,data.map[j*mapSizeX+i]||0)}}for(var n=0;n<data.sfx.length;n++){asset(n,data.sfx[n].speed);for(var offset=0;offset<data.sfx[n].volumes.length;offset++){avset(n,offset,data.sfx[n].volumes[offset]);afset(n,offset,data.sfx[n].pitches[offset]);awset(n,offset,data.sfx[n].waves[offset])}}spriteSheetDirty=true;if(typeof _load==="function"){runUserFunction(_load)}}function runUserFunction(func){if(typeof func==="function"){try{func()}catch(err){if(typeof _error==="function"){_error(utils.getErrorInfo(err))}console.error(err)}}}function updateMapCacheCanvas(x,y){var n=mget(x,y);mapCacheContext.clearRect(x*cellsizeX,y*cellsizeY,cellsizeX,cellsizeY);if(spriteSheetDirty)redrawSpriteSheet();mapCacheContext.drawImage(spriteSheetCanvas,ssx(n)*cellsizeX,ssy(n)*cellsizeY,cellsizeX,cellsizeY,cellsizeX*x,cellsizeY*y,cellsizeX,cellsizeY)}exports.help=function(){help.print()};exports.mousex=function(){return Math.floor(mouse.mousexNormalized()*(screensizeX-1))};exports.mousey=function(){return Math.floor(mouse.mouseyNormalized()*(screensizeY-1))};utils.makeGlobal(music);utils.makeGlobal(math);utils.makeGlobal(sfx.global);utils.makeGlobal(code);utils.makeGlobal(exports);utils.makeGlobal(input.global);utils.makeGlobal(mouse.global);help.hello();help.print()},{"./code":2,"./colors":3,"./font":4,"./help":5,"./input":7,"./math":8,"./mouse":9,"./music":10,"./pixelops":11,"./sfx":12,"./utils":13}],7:[function(require,module,exports){var math=require("./math");var utils=require("./utils");var maxPlayers=6;var maxButtons=5;var buttonStates=utils.zeros(maxPlayers*maxButtons);var prevButtonStates=utils.zeros(maxPlayers*maxButtons);var buttonMap={37:0,39:1,38:2,40:3,90:4,88:5,83:6,70:7,69:8,68:9,65:10,81:11};var stickSensitivity=.1;exports.btn=function btn(i,player){i=i!==undefined?i:0;player=player!==undefined?player:0;return buttonStates[player*maxPlayers+i]};exports.btnp=function btnp(i,player){i=i!==undefined?i:0;player=player!==undefined?player:0;return prevButtonStates[player*maxPlayers+i]};exports.update=function(){updateGamepadInputs();for(var i=0;i<buttonStates.length;i++){prevButtonStates[i]=buttonStates[i]}};exports.init=function(canvases){addInputListeners(canvases)};function addInputListeners(canvases){bodyListeners={keydown:function(e){buttonStates[buttonMap[e.keyCode]]=1},keyup:function(e){buttonStates[buttonMap[e.keyCode]]=0}};for(var key in bodyListeners){document.body.addEventListener(key,bodyListeners[key])}}function removeInputListeners(canvases){var key;for(key in canvasListeners){canvases[0].removeEventListener(key,canvasListeners[key])}for(key in bodyListeners){document.body.removeEventListener(key,bodyListeners[key])}}function buttonPressed(b){if(typeof b=="object"){return b.pressed}return b==1}function updateGamepadInputs(){var gamepads=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];for(var i=0;i<gamepads.length&&i<maxPlayers;i++){if(!gamepads[i])continue;var p=2+maxPlayers*i;buttonStates[p+0]=gamepads[i].axes[0]<-stickSensitivity;buttonStates[p+1]=gamepads[i].axes[0]>stickSensitivity;buttonStates[p+2]=gamepads[i].axes[1]<-stickSensitivity;buttonStates[p+3]=gamepads[i].axes[1]>stickSensitivity;buttonStates[p+4]=buttonPressed(gamepads[i].buttons[0]);buttonStates[p+5]=buttonPressed(gamepads[i].buttons[1])}}exports.global={btn:exports.btn,btnp:exports.btnp}},{"./math":8,"./utils":13}],8:[function(require,module,exports){var tau=2*Math.PI;module.exports={sin:function(radians){return Math.sin(radians*tau)},cos:function(radians){return Math.cos(radians*tau)},atan2:function(y,x){return Math.atan2(y,x)/tau},flr:Math.floor,ceil:Math.ceil,rnd:function(x){return Math.random()*x},abs:Math.abs,max:Math.max,min:Math.min,nan:isNaN,inf:Infinity,mix:function(a,b,alpha){return a*alpha+b*(1-alpha)},sgn:Math.sign,sqrt:Math.sqrt,mid:function(x,y,z){var m=z;if(x>=y&&x<=z){m=x}else if(y>=x&&y<=z){m=y}else if(z>=x&&z<=y){m=z}return m},clamp:function(x,min,max){return Math.min(Math.max(x,min),max)}}},{}],9:[function(require,module,exports){var math=require("./math");var utils=require("./utils");var _mousex=0;var _mousey=0;var _mousescroll=0;var _mousebtns={};exports.init=function(canvases){addListeners(canvases)};exports.mousex=function mousex(){return _mousex};exports.mousey=function mousey(){return _mousey};exports.mousescroll=function mousescroll(){return _mousescroll};exports.mousebtn=function mousebtn(i){return!!_mousebtns[i]};function addListeners(canvases){canvasListeners={click:function(evt){if(typeof _click!=="undefined"){updateMouseCoords(evt,canvases);_mousebtns[evt.which]=true;_click();_mousebtns[evt.which]=false}},mousedown:function(evt){_mousebtns[evt.which]=true;updateMouseCoords(evt,canvases)},mouseup:function(evt){_mousebtns[evt.which]=false;updateMouseCoords(evt,canvases)},mouseleave:function(evt){_mousebtns[evt.which]=false;updateMouseCoords(evt,canvases)},mousewheel:function(evt){var delta=Math.max(-1,Math.min(1,evt.wheelDelta||-evt.detail));_mousescroll+=delta}};canvasListeners.DOMMouseScroll=canvasListeners.mousewheel;var key;for(key in canvasListeners){canvases[0].addEventListener(key,canvasListeners[key])}bodyListeners={mousemove:function(evt){updateMouseCoords(evt,canvases)}};for(key in bodyListeners){document.body.addEventListener(key,bodyListeners[key])}}function removeListeners(canvases){var key;for(key in canvasListeners){canvases[0].removeEventListener(key,canvasListeners[key])}for(key in bodyListeners){document.body.removeEventListener(key,bodyListeners[key])}}function updateMouseCoords(evt,canvases){if(canvases.indexOf(evt.target)===-1)return;var rect=evt.target.getBoundingClientRect();var parentRect=evt.target.parentNode.getBoundingClientRect();var subx=0;var suby=0;_mousex=math.clamp((evt.clientX-rect.left-subx)/rect.width,0,1);_mousey=math.clamp((evt.clientY-rect.top-suby)/rect.height,0,1)}exports.mousexNormalized=function(){return _mousex};exports.mouseyNormalized=function(){return _mousey};exports.global={mousebtn:exports.mousebtn,click:exports.click,mousescroll:exports.mousescroll}},{"./math":8,"./utils":13}],10:[function(require,module,exports){var utils=require("./utils");var sfx=require("./sfx");var frequencies=[261.63,277.18,277.18,293.66,311.13,311.13,329.63,349.23,369.99,369.99,392,415.3,415.3,440,466.16,466.16,493.88,523.25,554.37,554.37,587.33,622.25,622.25,659.26,698.46,739.99,739.99,783.99,830.61,830.61,880,932.33,932.33,987.77,1046.5,1108.73,1108.73,1174.66,1244.51,1244.51,1318.51,1396.91,1479.98,1479.98,1567.98,1661.22,1661.22,1760,1864.66,1864.66,1975.53,2093,2217.46,2217.46,2349.32,2489.02,2489.02,2637.02,2793.83,2959.96,2959.96,3135.96,3322.44,3322.44,3520,3729.31,3729.31,3951.07,4186.01];var noteNames="C C# Db D D# Eb E F F# Gb G G# Ab A A# Bb B".split(" ");var PatternFlags={ACTIVE:1,THROW:2,CATCH:4,STOP:8};function getFrequency(pitch,octave){return frequencies[octave*noteNames.length+pitch]}var groups=[];var patterns=utils.zeros(8*(4+1));while(groups.length<8){var group={speed:16,notes:utils.zeros(5*8*4)};groups.push(group)}exports.gsset=function(group,speed){groups[group].speed=speed};exports.gsget=function(group){return groups[group].speed};exports.npset=function(group,position,pitch){if(pitch<0||pitch>noteNames.length)throw new Error("Pitch out of range");groups[group].notes[5*position+0]=pitch};exports.npget=function(group,position){return groups[group].notes[5*position+0]};exports.nnget=function(note){return noteNames[note%17]};exports.noset=function(group,position,octave){if(octave<0||octave>8)throw new Error("Octave out of range");groups[group].notes[5*position+1]=octave};exports.noget=function(group,position){return groups[group].notes[5*position+1]};exports.nvset=function(group,position,volume){groups[group].notes[5*position+3]=volume};exports.nvget=function(group,position){return groups[group].notes[5*position+3]};exports.niset=function(group,position,instrument){groups[group].notes[5*position+2]=instrument};exports.niget=function(group,position){return groups[group].notes[5*position+2]};exports.mgset=function(pattern,channel,group){patterns[pattern*5+1+channel]=group};exports.mgget=function(pattern,channel){return patterns[pattern*5+1+channel]};exports.mfset=function(pattern,flags){patterns[pattern*5+0]=flags};exports.mfget=function(pattern){return patterns[pattern*5+0]};var context=sfx.getContext();var masterGain=sfx.getMasterGain();var channels=[];var oscillatorTypes=sfx.getOscillatorTypes();var allTypes=sfx.getAllOscillatorTypes();for(var j=0;j<4;j++){var channel={instruments:{},gains:{}};channels.push(channel);for(var i=0;i<oscillatorTypes.length;i++){var osc=context.createOscillator();var type=oscillatorTypes[i];osc.type=type;var gain=context.createGain();gain.gain.value=0;gain.connect(masterGain);osc.connect(gain);channel.instruments[type]=osc;channel.gains[type]=gain;osc.start(context.currentTime)}var gain=context.createGain();gain.gain.value=0;gain.connect(masterGain);var square25=sfx.createPulse(gain);channel.instruments.square25=square25;channel.gains.square25=gain;square25.start(context.currentTime);gain=context.createGain();gain.gain.value=0;
gain.connect(masterGain);var whiteNoise=sfx.createWhiteNoise(gain);channel.instruments.white=whiteNoise;channel.gains.white=gain;whiteNoise.start(context.currentTime)}exports.group=function(groupIndex,channelIndex){scheduleGroup(groupIndex,channelIndex||0,context.currentTime)};function scheduleGroup(groupIndex,channelIndex,time){var i,j;var group=groups[groupIndex];var channel=channels[channelIndex];var speed=group.speed;for(var i=0;i<32;i++){var volume=nvget(groupIndex,i);var pitch=npget(groupIndex,i);var octave=noget(groupIndex,i);var instrument=niget(groupIndex,i);if(volume===0){continue}var startPosition=i;var endPosition=i+1;while(nvget(groupIndex,endPosition)===volume&&niget(groupIndex,endPosition)===instrument&&npget(groupIndex,endPosition)===pitch&&endPosition<32){endPosition++}var startTime=time+startPosition/speed;var endTime=time+endPosition/speed;var osc=channel.instruments[allTypes[instrument]];var gain=channel.gains[allTypes[instrument]];if(osc.frequency){var frequency=getFrequency(pitch,octave);osc.frequency.setValueAtTime(frequency,startTime)}gain.gain.setValueAtTime(volume/7,startTime);gain.gain.setValueAtTime(0,endTime);i=endPosition-1}}exports.music=function(patternIndex,fade,channelmask){fade=fade!==undefined?fade:0;channelmask=channelmask!==undefined?channelmask:0;if(patternIndex===-1){stop(fade);return}var startTime=context.currentTime;for(var patternIndex=0;patternIndex<patterns.length;patternIndex++){var flags=mfget(patternIndex);if(!(flags&PatternFlags.ACTIVE))continue;for(var channelIndex=0;channelIndex<channels.length;channelIndex++){var groupIndex=mgget(patternIndex,channelIndex);var speed=gsget(groupIndex);scheduleGroup(groupIndex,channelIndex,startTime)}}};function stop(fade){var currentTime=context.currentTime;for(var channelIndex=0;channelIndex<channels.length;channelIndex++){var channel=channels[channelIndex];for(var i=0;i<allTypes.length;i++){var instrument=channel.instruments[allTypes[i]];if(instrument.frequency){instrument.frequency.cancelAllScheduledValues()}instrument.gain.cancelAllScheduledValues();instrument.gain.setValueAtTime(0,currentTime)}}}},{"./sfx":12,"./utils":13}],11:[function(require,module,exports){var ctx;var writeData=null;var readData=null;var width;var height;var pixelsQueued=0;var tempCanvas=null;var tempCanvasContext=null;exports.init=function(canvas){ctx=canvas.getContext("2d");writeData=ctx.createImageData(canvas.width,canvas.height);width=canvas.width;height=canvas.height;tempCanvas=document.createElement("canvas");tempCanvas.width=width;tempCanvas.height=height;tempCanvasContext=tempCanvas.getContext("2d")};exports.resize=function(canvas){exports.init(canvas)};exports.beforeChange=function(){readData=null;if(pixelsQueued!==0){exports.flush()}};exports.pset=function(x,y,r,g,b){var p=(y*width+x)*4;var data=writeData.data;if(p<0||p+3>data.length)return;data[p+0]=r;data[p+1]=g;data[p+2]=b;data[p+3]=255;pixelsQueued++};exports.pget=function(x,y,out){var p=(y*width+x)*4;if(writeData.data[p+3]===255){out[0]=writeData.data[p+0];out[1]=writeData.data[p+1];out[2]=writeData.data[p+2]}else{if(!readData){readData=ctx.getImageData(0,0,width,height)}out[0]=readData.data[p+0];out[1]=readData.data[p+1];out[2]=readData.data[p+2]}};exports.flush=function(){if(pixelsQueued===0)return;var sourceX=0;var sourceY=0;var destX=0;var destY=0;tempCanvasContext.putImageData(writeData,sourceX,sourceY,destX,destY,width,height);ctx.drawImage(tempCanvas,0,0);pixelsQueued=0;exports.beforeChange();var data=writeData.data;for(var i=0;i<width;i++){for(var j=0;j<height;j++){data[(j*width+i)*4+3]=0}}}},{}],12:[function(require,module,exports){var utils=require("./utils");var DFT=require("dsp.js/dsp").DFT;var minFrequency=0;var maxFrequency=1e3;var maxEffects=64;var channels=[];var effects=[];var context=new createAudioContext;var masterGain=context.createGain();masterGain.gain.value=1;masterGain.connect(context.destination);exports.getContext=function(){return context};exports.getMasterGain=function(){return masterGain};var oscillatorTypes=["sine","square","triangle","sawtooth"];var allTypes=oscillatorTypes.concat(["square25","white"]);exports.getOscillatorTypes=function(){return oscillatorTypes};exports.getAllOscillatorTypes=function(){return allTypes};function createAudioContext(desiredSampleRate){var AudioCtor=window.AudioContext||window.webkitAudioContext;desiredSampleRate=typeof desiredSampleRate==="number"?desiredSampleRate:44100;var context=new AudioCtor;if(/(iPhone|iPad)/i.test(navigator.userAgent)&&context.sampleRate!==desiredSampleRate){var buffer=context.createBuffer(1,1,desiredSampleRate);var dummy=context.createBufferSource();dummy.buffer=buffer;dummy.connect(context.destination);dummy.start(0);dummy.disconnect();context.close();context=new AudioCtor}return context}function play(channel,types,frequencies,volumes,speed,offset){var i,j;var osc=channel.oscillators[allTypes[types[offset+0]]];var gain=channel.gains[allTypes[types[offset+0]]];var endPosition=0;for(i=0;i<volumes.length;i++){if(volumes[i]>0){endPosition=i+1}}if(endPosition===0)return;var currentTime=context.currentTime;for(i=offset;i<endPosition;i++){var type=allTypes[types[i]];osc=channel.oscillators[type];var startTime=currentTime+i/speed;for(j=0;j<allTypes.length;j++){gain=channel.gains[allTypes[j]];if(allTypes[j]!==type){gain.gain.setValueAtTime(0,startTime)}else{if(osc.frequency){osc.frequency.setValueAtTime(frequencies[i]/255*(maxFrequency-minFrequency)+minFrequency,startTime)}var vol=volumes[i]/255;gain.gain.setValueAtTime(vol,startTime)}}}var len=(endPosition-offset)/speed;var endTime=currentTime+len;for(j=0;j<allTypes.length;j++){gain=channel.gains[allTypes[j]];gain.gain.setValueAtTime(0,endTime)}channel.occupiedUntil=endTime}exports.asset=function(n,speed){effects[n].speed=speed};exports.asget=function(n){return effects[n].speed};exports.avset=function(n,offset,volume){effects[n].volumes[offset]=volume};exports.avget=function(n,offset){return effects[n].volumes[offset]};exports.afset=function(n,offset,frequency){effects[n].frequencies[offset]=frequency};exports.afget=function(n,offset){return effects[n].frequencies[offset]};exports.awset=function(n,offset,waveform){effects[n].types[offset]=waveform};exports.awget=function(n,offset){return effects[n].types[offset]};exports.sfx=function(n,channelIndex,offset){channelIndex=channelIndex!==undefined?channelIndex:-1;offset=offset!==undefined?offset:0;var effect=effects[n];if(!effect){return false}var contextTime=context.currentTime;if(channelIndex===-1){for(var i=0;i<channels.length;i++){var candidateIndex=i;if(channels[candidateIndex].occupiedUntil<contextTime){channelIndex=candidateIndex;break}}}else if(channels[channelIndex].occupiedUntil>=contextTime){return false}if(!channels[channelIndex]){return false}play(channels[channelIndex],effect.types,effect.frequencies,effect.volumes,effect.speed,offset);return true};var whiteNoiseData=null;exports.createWhiteNoise=function(destination){var bufferSize=2*context.sampleRate,noiseBuffer=context.createBuffer(1,bufferSize,context.sampleRate),output=noiseBuffer.getChannelData(0);if(!whiteNoiseData){whiteNoiseData=new Float32Array(bufferSize);for(var i=0;i<bufferSize;i++){whiteNoiseData[i]=Math.random()*2-1}}output.set(whiteNoiseData);var whiteNoise=context.createBufferSource();whiteNoise.buffer=noiseBuffer;whiteNoise.loop=true;whiteNoise.connect(destination);return whiteNoise};var dft=null;exports.createPulse=function(destination){if(!dft){var count=128;var vals2=[];for(var i=0;i<count;i++){var x=i/count;var val=x<.25?-1:1;vals2.push(val)}dft=new DFT(vals2.length);dft.forward(vals2)}var table=context.createPeriodicWave(new Float32Array(dft.real),new Float32Array(dft.imag));osc=context.createOscillator();osc.setPeriodicWave(table);osc.connect(destination);return osc};for(var j=0;j<4;j++){var channel={oscillators:{},gains:{},occupiedUntil:-1};channels.push(channel);for(var i=0;i<oscillatorTypes.length;i++){var osc=context.createOscillator();var type=oscillatorTypes[i];osc.type=type;var gain=context.createGain();gain.gain.value=0;gain.connect(masterGain);osc.connect(gain);channel.oscillators[type]=osc;channel.gains[type]=gain;osc.start(context.currentTime)}var gain=context.createGain();gain.gain.value=0;gain.connect(masterGain);var square25=exports.createPulse(gain);channel.oscillators.square25=square25;channel.gains.square25=gain;square25.start(context.currentTime);gain=context.createGain();gain.gain.value=0;gain.connect(masterGain);var whiteNoise=exports.createWhiteNoise(gain);channel.oscillators.white=whiteNoise;channel.gains.white=gain;whiteNoise.start(context.currentTime)}for(var i=0;i<maxEffects;i++){effects.push({types:utils.zeros(maxEffects),frequencies:utils.zeros(maxEffects),volumes:utils.zeros(maxEffects),speed:16})}exports.global={asset:exports.asset,asget:exports.asget,avset:exports.avset,avget:exports.avget,afset:exports.afset,afget:exports.afget,awset:exports.awset,awget:exports.awget,sfx:exports.sfx}},{"./utils":13,"dsp.js/dsp":1}],13:[function(require,module,exports){exports.disableImageSmoothing=function(ctx){if(ctx.imageSmoothingEnabled!==undefined){ctx.imageSmoothingEnabled=false}else if(ctx.mozImageSmoothingEnabled!==undefined){ctx.mozImageSmoothingEnabled=false}else if(ctx.webkitImageSmoothingEnabled!==undefined){ctx.webkitImageSmoothingEnabled=false}else if(ctx.msImageSmoothingEnabled!==undefined){ctx.msImageSmoothingEnabled=false}};exports.hexToRgb=function hexToRgb(hex){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return[parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16)]};exports.rgbToDec=function(r,g,b){var c=r*(256*256)+g*256+b;return c};exports.decToR=function(c){return Math.floor(c/(256*256))};exports.decToG=function(c){return Math.floor(c/256)%256};exports.decToB=function(c){return c%256};function isSafari(){return navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1}exports.isMac=function(){return navigator.platform.match("Mac")};exports.makeGlobal=function(obj){for(var key in obj){window[key]=obj[key]}};exports.scaleToFit=function scaleToFit(element,containerElement,pixelPerfectMode){var containerWidth=window.innerWidth;var containerHeight=window.innerHeight;if(containerElement){var rect=containerElement.getBoundingClientRect();containerWidth=rect.width;containerHeight=rect.height}var scaleX=containerWidth/element.width;var scaleY=containerHeight/element.height;var scale=Math.min(scaleX,scaleY);var dpr=window.devicePixelRatio||1;if(pixelPerfectMode){scale=Math.floor(scale*dpr)/dpr||1/dpr}var offsetX=(containerWidth-element.width*scale)*.5;var offsetY=(containerHeight-element.height*scale)*.5;if(pixelPerfectMode){offsetX=Math.floor(offsetX*dpr)/dpr;offsetY=Math.floor(offsetY*dpr)/dpr}if(isSafari()){element.style.width=element.width*scale+"px";element.style.height=element.height*scale+"px";element.style.marginLeft=offsetX+"px";element.style.marginTop=offsetY+"px"}else{element.style.transformOrigin="0 0";element.style.transform="translate("+offsetX+"px, "+offsetY+"px) scale("+scale+")"}};exports.fullscreen=function(element){if(document.fullscreenElement)return false;if(element.requestFullscreen){element.requestFullscreen()}else if(element.msRequestFullscreen){element.msRequestFullscreen()}else if(element.mozRequestFullScreen){element.mozRequestFullScreen()}else if(element.webkitRequestFullscreen){element.webkitRequestFullscreen()}else{return false}return true};exports.zeros=function(n,reusableArray){if(reusableArray===undefined){var a=[];while(n--){a.push(0)}return a}else{for(var i=0;i<reusableArray.length;i++){reusableArray[0]=0}while(reusableArray.length<n)reusableArray.push(0);return reusableArray}};exports.createCanvas=function(w,h,pixelSmoothing){pixelSmoothing=pixelSmoothing===undefined?true:pixelSmoothing;var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;if(pixelSmoothing){exports.disableImageSmoothing(canvas.getContext("2d"))}return canvas};exports.createCanvasFromAscii=function(asciiArray,charToColorMap){var width=asciiArray[0].length;var height=asciiArray.length;var canvas=exports.createCanvas(width,height);var ctx=canvas.getContext("2d");var imageData=ctx.createImageData(width,height);for(var i=0;i<height;i++){for(var j=0;j<width;j++){var p=4*(i*width+j);var rgba=charToColorMap[asciiArray[i][j]];imageData.data[p+0]=rgba[0];imageData.data[p+1]=rgba[1];imageData.data[p+2]=rgba[2];imageData.data[p+3]=rgba[3]}}ctx.putImageData(imageData,0,0);return canvas};exports.getErrorInfo=function(err){var line=-1;var column=-1;if(err.lineNumber!==undefined&&err.columnNumber!==undefined){line=err.lineNumber;column=err.columnNumber}else if(err.line!==undefined&&err.column!==undefined){line=err.line;column=err.column}var stack=err.stack;var m=stack.match(/:(\d+):(\d+)/gm);if(m){var nums=m[1].split(":");line=parseInt(nums[1]);column=parseInt(nums[2])}return{message:err.message,line:line,column:column,originalError:err}}},{}]},{},[6]);